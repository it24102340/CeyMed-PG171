<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Notifications</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="/"><i class="fas fa-shield-alt me-2"></i>CeyMed Insurance</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/policy/policies">Policies</a></li>
                <li class="nav-item" th:if="${session.user != null}"><a class="nav-link" href="/purchase/history">My Purchases</a></li>
                <li class="nav-item" th:if="${session.user != null}"><a class="nav-link" href="/claims/submit">Submit Claim</a></li>
                <li class="nav-item" th:if="${session.user != null}"><a class="nav-link" href="/claims/my-claims">My Claims</a></li>
                <li class="nav-item" th:if="${session.user != null}"><a class="nav-link active fw-semibold" href="/notifications/my-notifications">Notifications</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-bell me-2"></i>My Notifications</h2>
        <div class="d-flex gap-2">
            <span class="badge bg-primary fs-6" th:if="${unreadCount > 0}" th:text="${unreadCount} + ' unread'"></span>
            <button class="btn btn-outline-primary btn-sm" onclick="markAllAsRead()">
                <i class="fas fa-check-double me-1"></i>Mark All as Read
            </button>
        </div>
    </div>

    <!-- Notifications List -->
    <div th:if="${notifications != null and !notifications.empty}" class="row">
        <div th:each="notification : ${notifications}" class="col-12 mb-3">
            <div class="card" th:classappend="${!notification.isRead} ? 'border-primary' : ''">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-2" th:text="${notification.title}"></h5>
                            <p class="card-text" th:text="${notification.message}"></p>
                            <small class="text-muted" th:text="${#temporals.format(notification.createdDate, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                        <div class="d-flex flex-column align-items-end">
                            <span class="badge mb-2" th:classappend="${notification.type.name() == 'CLAIM_APPROVED'} ? 'bg-success' : 
                                                      (${notification.type.name() == 'CLAIM_REJECTED'} ? 'bg-danger' : 
                                                      (${notification.type.name() == 'CLAIM_REQUIRES_DOCUMENTS'} ? 'bg-warning' : 'bg-info'))"
                                  th:text="${notification.type.displayName}"></span>
                            <button th:if="${!notification.isRead}" class="btn btn-outline-primary btn-sm" 
                                    th:onclick="'markAsRead(' + ${notification.notificationId} + ')'">
                                <i class="fas fa-check me-1"></i>Mark as Read
                            </button>
                            <span th:if="${notification.isRead}" class="text-success small">
                                <i class="fas fa-check me-1"></i>Read
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div th:if="${notifications == null or notifications.empty}" class="text-center py-5">
        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Notifications</h4>
        <p class="text-muted">You don't have any notifications yet.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function markAsRead(notificationId) {
        fetch('/notifications/mark-read/' + notificationId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.text())
        .then(data => {
            if (data.includes('marked as read')) {
                location.reload();
            } else {
                alert('Failed to mark notification as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark notification as read');
        });
    }

    function markAllAsRead() {
        fetch('/notifications/mark-all-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.text())
        .then(data => {
            if (data.includes('marked as read')) {
                location.reload();
            } else {
                alert('Failed to mark all notifications as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark all notifications as read');
        });
    }

    // Auto-refresh unread count every 30 seconds
    setInterval(function() {
        fetch('/notifications/unread-count')
        .then(response => response.json())
        .then(count => {
            const badge = document.querySelector('.badge.bg-primary');
            if (count > 0) {
                if (badge) {
                    badge.textContent = count + ' unread';
                } else {
                    // Create badge if it doesn't exist
                    const container = document.querySelector('.d-flex.gap-2');
                    if (container) {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge bg-primary fs-6';
                        newBadge.textContent = count + ' unread';
                        container.insertBefore(newBadge, container.firstChild);
                    }
                }
            } else if (badge) {
                badge.remove();
            }
        })
        .catch(error => console.error('Error fetching unread count:', error));
    }, 30000);
</script>
</body>
</html>
